<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Processing App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .card {
            max-width: 500px;
            margin: auto;
        }

        .form-group button {
            width: 100%;
        }

        .node-status {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
            margin-top: 10px;
        }

        .btn-status {
            width: 100px;
            text-align: center;
            pointer-events: none;
        }

        .btn-status .node-name {
            font-weight: bold;
            display: block;
        }

        @media (max-width: 576px) {
            .form-control-lg {
                font-size: 1rem;
                padding: .5rem .75rem;
            }

            .btn-lg {
                font-size: 1rem;
                padding: .5rem .75rem;
            }
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header text-center">
                <h1>Image Processing App</h1>
            </div>
            <div class="card-body">
                <div class="form-group text-center">
                    <label for="uploadInput" class="btn btn-info btn-lg">
                        <i class="fas fa-upload"></i> Upload Image
                    </label>
                    <input type="file" class="form-control-file" id="uploadInput" style="display: none;"
                        onchange="displayFileName()">
                    <div id="fileName" class="mt-2"></div>
                </div>
                <div class="form-group text-center">
                    <label for="operationSelect" class="font-weight-bold">Select Operation</label>
                    <select class="form-control form-control-lg mt-2" id="operationSelect">
                        <option value="">Select an operation</option>
                        <option value="grayscale">Grayscale</option>
                        <option value="blur">Blur</option>
                        <option value="color_inversion">Color Inversion</option>
                    </select>
                </div>
                <div class="form-group text-center">
                    <button class="btn btn-success btn-lg mt-3" id="processImgBtn" onclick="processImage()">
                        <i class="fas fa-cogs"></i> Process Image
                    </button>
                </div>
                <div class="form-group text-center">
                    <div class="progress mt-3" style="height: 30px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width: 0%">0%</div>
                    </div>
                </div>
                <div class="form-group text-center">
                    <div id="errorImage" class="alert alert-danger d-none" role="alert">Please select an image.</div>
                    <div id="errorOperation" class="alert alert-danger d-none" role="alert">Please select an operation.
                    </div>
                    <div id="errorFetch" class="alert alert-danger d-none" role="alert">Failed to process image.</div>
                </div>
                <div class="form-group text-center">
                    <h4 class="mt-4">Node Status</h4>
                    <div class="node-status">
                        <button class="btn btn-status btn-secondary" id="masterNodeStatus"><span
                                class="node-name">Master Node</span><span id='masternode'>loading...</span></button>
                    </div>
                    <div class="node-status">
                        <button class="btn btn-status btn-secondary" id="workerNode1Status"><span
                                class="node-name">Worker Node 1</span><span id='worker1'>loading...</span></button>
                    </div>
                    <div class="node-status">
                        <button class="btn btn-status btn-secondary" id="workerNode2Status"><span
                                class="node-name">Worker Node 2</span><span id='worker2'>loading...</span></button>
                    </div>
                    <div class="node-status">
                        <button class="btn btn-status btn-secondary" id="workerNode3Status"><span
                                class="node-name">Worker Node 3</span><span id='worker3'>loading...</span></button>
                    </div>
                    <div class="node-status">
                        <button class="btn btn-status btn-secondary" id="workerNode4Status"><span
                                class="node-name">Worker Node 4</span><span id='worker4'>loading...</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function displayFileName() {
            var uploadInput = document.getElementById('uploadInput');
            var fileName = document.getElementById('fileName');
            if (uploadInput.files.length > 0) {
                fileName.textContent = 'File: ' + uploadInput.files[0].name;
                fileName.classList.add('alert', 'alert-success');
            } else {
                fileName.textContent = '';
                fileName.classList.remove('alert', 'alert-success');
            }
        }

        function processImage() {
            var uploadInput = document.getElementById('uploadInput');
            var operationSelect = document.getElementById('operationSelect');
            var file = uploadInput.files[0];
            var operation = operationSelect.value;
            var errorImage = document.getElementById('errorImage');
            var errorOperation = document.getElementById('errorOperation');
            var errorFetch = document.getElementById('errorFetch');
            var progressBar = document.getElementById('progressBar');
            var processImgBtn = document.getElementById('processImgBtn');
            // Hide all error messages
            errorImage.classList.add('d-none');
            errorOperation.classList.add('d-none');
            errorFetch.classList.add('d-none');
            
            processImgBtn.disabled = true;

            if (!file) {
                errorImage.classList.remove('d-none');
                processImgBtn.disabled = false;
            }
            if (!operation) {
                errorOperation.classList.remove('d-none');
                processImgBtn.disabled = false;
            }
            if (file && operation) {
                var formData = new FormData();
                formData.append('image', file);
                formData.append('operation', operation);

                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');

                fetch('http://16.171.176.44:5000/process_image', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to process image');
                            processImgBtn.disabled = false;
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'processed_image.jpg';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);

                        // Simulate progress completion
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                        processImgBtn.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        errorFetch.textContent = error.message;
                        errorFetch.classList.remove('d-none');
                        processImgBtn.disabled = false;
                    });
            }
        }
        /*
        function updateNodeStatus(nodeId, status) {
            var node = document.getElementById(nodeId);
            var statusText = node.querySelector('span:last-child');
            statusText.textContent = status;
            node.className = 'btn btn-status';
            if (status === 'Online') {
                node.classList.add('btn-success');
            } else if (status === 'Offline') {
                node.classList.add('btn-danger');
            } else {
                node.classList.add('btn-secondary');
            }
        }

        // Example usage to update node statuses
        updateNodeStatus('masterNodeStatus', 'Online');
        updateNodeStatus('workerNode1Status', 'Online');
        updateNodeStatus('workerNode2Status', 'Offline');
        updateNodeStatus('workerNode3Status', 'Online');
        updateNodeStatus('workerNode4Status', 'Offline');
        */
    </script>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const socket = io('http://13.60.62.85:5001');

        socket.on('connect', () => {
                console.log('Connected to WebSocket server');
        });

        socket.on('status', (data) => {
                console.log(data.message);
        });
        /*
        socket.on('node_status', (statuses) => {
                console.log('Received statuses:', statuses);
                updateNodeStatus('masterNodeStatus', statuses['i-01a28545a12ed89df']);
                updateNodeStatus('workerNode1Status', statuses['i-0339bfe4046feb681']);
                updateNodeStatus('workerNode2Status', statuses['i-081cc29642db6b146']);
                updateNodeStatus('workerNode3Status', statuses['i-0141d647c9071826e']);
                updateNodeStatus('workerNode4Status', statuses['i-027ebee0933814be0']);
                // Add similar lines for all your worker nodes
        });
        */
        socket.on('node_status', (statuses) => {
                console.log('Received statuses:', statuses);
                updateNodeStatus('masterNodeStatus', statuses['masterNodeStatus']);
                updateNodeStatus('workerNode1Status', statuses['workerNode1Status']);
                updateNodeStatus('workerNode2Status', statuses['workerNode2Status']);
                updateNodeStatus('workerNode3Status', statuses['workerNode3Status']);
                updateNodeStatus('workerNode4Status', statuses['workerNode4Status']);
                // Add similar lines for all your worker nodes
        });

        function updateNodeStatus(nodeId, status) {
                const node = document.getElementById(nodeId);
                const statusText = node.querySelector('span:last-child');
                statusText.textContent = status;
                node.className = 'btn btn-status';
                if (status.includes('running')) {
                        node.classList.add('btn-success');
                } else if (status === 'stopped') {
                        node.classList.add('btn-danger');
                } else {
                        node.classList.add('btn-secondary');
                }
        }
        </script>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>